#####################################################################################
#####################################################################################
#                                                                                   #
#                 Bienvenido/a a la calculadora de hipotecas inversas               #
#                                                                                   #
#   Fecha: 16/01/2025                                                               #
#   Versión: 1.0                                                                    #
#                                                                                   #
#   El código de este programa está pensado para cargar el entorno y las bases      #
#   de datos directamente desde el script. Si por alguna razón el código diese      #
#   problemas en lo relativo al entorno, puedes cargarlo manualmente desde los      #
#   archivos adjuntos en la carpeta.                                                #
#                                                                                   #
#   Dataframe:  VIVIENDA.xlsx   TABLA_VIDA.xlsx                                     #
#   Funciones:  Funciones_entorno.txt                                               #
#   Values:     Los valores se introducen mediante el programa                      #
#                                                                                   #
#   El programa requiere algo de CPU y potencia computacional, si en algún          #
#   paso parece que se queda colgado, revisa en el administrador de tareas          #
#   si R Studio está consumiendo CPU, o el consumo es superior al 5-6%,             #
#   significa que el programa está calculando; en caso contrario, es que algo en    #
#   el código ha fallado.                                                           #
#                                                                                   #
#   El trabajo ha consistido en una parte teórica y una parte práctica. La          #
#   parte teórica consiste en el desarrollo del modelo matemático-actuarial         #
#   que he utilizado para realizar el programa. NO ES ESTRICTAMENTE NECESARIO       #
#   LEER LA PARTE TEÓRICA DEL TRABAJO. La parte práctica, por otro lado,            #
#   consiste en modificar bases de datos del INE y procesar datos necesarios        #
#   para nutrir el programa. Luego, implementar las funciones del modelo,           #
#   "lo cual ha sido una hazaña remarcable". Entre ellas, he tenido que aprender    #
#   algo de métodos numéricos. En particular, el único método numérico que ha       #
#   resultado útil ha sido el algoritmo Newton-Raphson multidimensional.            #
#   Finalmente, he creado el código principal, un programa interactivo que carga    #
#   los pasos anteriores en el entorno de R y ofrece resultados.                    #
#                                                                                   #
#   El código principal funciona de la siguiente manera:                            #
#   1. Toma de datos.                                                               #
#   2. Procesa los datos utilizando dataframes y funciones.                         #
#   3. Selecciona uno de los dos métodos de análisis.                               #
#   4. Realiza el análisis mediante métodos numéricos, tablas y plots.              #
#   5. Te permite volver al inicio del programa para volver a calcular.             #
#                                                                                   #
#   Este trabajo ha requerido prácticamente la totalidad de mi tiempo desde         #
#   navidades. He de decir que estoy relativamente satisfecho con el resultado,     #
#   aunque creo que aún podrían mejorarse muchas cosas. Sin duda, la parte más      #
#   compleja del trabajo ha sido desarrollar el modelo desde 0 y tratar de          #
#   interpretarlo. El modelo acaba llegando a una conclusión que se resume          #
#   en un modelo de ecuaciones no lineales y no analíticas que no tienen solución   #
#   mediante los métodos de cálculo habituales. Por eso ha sido necesario           #
#   investigar métodos numéricos para poder calcular las primas de riesgo.          #
#                                                                                   #
#   Además, diseñar y poner en práctica todas las funciones ha sido una tarea       #
#   compleja. En particular, vector_val_H() ha sido bastante complejo de programar  #
#   debido a la cantidad de excepciones que tiene. newtonraphson_rktcontr(),        #
#   por otro lado, ha sido complicado debido a que he tenido que aprender desde 0   #
#   cómo funciona el algoritmo. Aunque es un algoritmo famoso y había muchas        #
#   fuentes, su implementación no fue sencilla.                                     #
#                                                                                   #
#   El código puede parecer algo incomprensible a primera vista, no lo niego. Por   #
#   eso es importante ejecutarlo desde source para simplemente dirigirlo desde la   #
#   consola de R Studio. En principio, todo debería acabar dando resultados.        #
#                                                                                   #
#   Finalmente, la memoria no está todo lo bien que me gustaría, pero es todo lo    #
#   que me ha dado tiempo a hacer desde el día 22 de diciembre. Es posible que la   #
#   modifique como parte de una publicación más extensa.                            #
#                                                                                   #
#                                                                                   #
#   Gracias por la atención!                                                        #
#                                                                                   #
#                                                                                   #
#   Sergi López Vergara                                                             #
#                                                                                   #
#####################################################################################
#####################################################################################
#####################################################################################





#######################################################################################
###-------- CARGA DE LOS DATAFRAMES DIRECTAMENTE DESDE EL TEXTO EN SCRIPT ----------### 
#######################################################################################


TABLA_VIDA <- structure(list(age = c(0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 
                                     12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 
                                     28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 
                                     44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 
                                     60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 
                                     76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 
                                     92, 93, 94, 95, 96, 97, 98, 99, 100, 101, 102, 103, 104, 105, 
                                     106), 
                             lx = c(100000, 99742.019104, 99721.066871, 99706.519199, 
                                    99695.554484, 99681.549289, 99672.985114, 99666.055292, 99660.728741, 
                                    99651.835389, 99644.496863, 99639.648006, 99632.350631, 99624.43103, 
                                    99618.022611, 99608.409585, 99599.214432, 99586.592635, 99571.743012, 
                                    99551.517619, 99527.356346, 99502.101212, 99476.220869, 99449.659529, 
                                    99423.924378, 99394.67252, 99363.569903, 99336.891257, 99306.887691, 
                                    99276.746158, 99245.292764, 99211.125214, 99175.254708, 99136.188731, 
                                    99093.014309, 99048.992827, 99001.523125, 98954.688592, 98898.395764, 
                                    98839.045759, 98781.48101, 98711.000978, 98635.205112, 98557.998366, 
                                    98469.563927, 98369.581121, 98266.623601, 98147.450233, 98021.020798, 
                                    97877.379364, 97716.943768, 97539.867525, 97334.06731, 97116.253275, 
                                    96862.563311, 96579.065139, 96257.279441, 95908.388901, 95519.405846, 
                                    95086.527353, 94627.626894, 94124.267957, 93573.784369, 92963.336567, 
                                    92307.385427, 91603.676809, 90845.502337, 90056.355803, 89154.590677, 
                                    88203.864791, 87177.261342, 86100.08697, 84951.027983, 83713.755663, 
                                    82381.309561, 80891.797859, 79263.740644, 77558.367933, 75641.06684, 
                                    73579.748627, 71305.906518, 68878.532301, 66318.661476, 63465.332154, 
                                    60257.586176, 56834.044024, 53102.181074, 49147.613301, 45085.155117, 
                                    40803.34622, 36353.79422, 31814.561787, 27408.986631, 23102.199438, 
                                    19137.167946, 15461.253392, 12194.609424, 9371.886288, 7069.166692, 
                                    5207.729669, 3733.038507, 0, 0, 0, 0, 0, 0), 
                             dx = c(257.980895999994, 
                                    20.9522330000036, 14.5476720000006, 10.9647150000092, 14.0051949999906, 
                                    8.5641750000068, 6.92982199999096, 5.32655100000557, 8.89335199999914, 
                                    7.33852600000682, 4.84885699998995, 7.2973750000092, 7.91960099998687, 
                                    6.40841900001396, 9.61302599999181, 9.19515300000785, 12.6217969999998, 
                                    14.8496229999873, 20.2253930000006, 24.1612730000052, 25.2551340000064, 
                                    25.8803429999971, 26.5613400000002, 25.7351510000008, 29.2518580000033, 
                                    31.1026169999968, 26.6786460000003, 30.0035659999994, 30.1415330000018, 
                                    31.4533939999965, 34.1675499999983, 35.8705060000066, 39.0659769999911, 
                                    43.1744219999964, 44.021482000011, 47.4697019999876, 46.8345330000011, 
                                    56.2928280000051, 59.3500050000002, 57.5647489999974, 70.4800320000068, 
                                    75.7958660000004, 77.2067459999962, 88.4344390000042, 99.982806, 
                                    102.957519999996, 119.173368000003, 126.429434999998, 143.641434000005, 
                                    160.435595999996, 177.076243000003, 205.800214999996, 217.814035000003, 
                                    253.68996399999, 283.498172000007, 321.785697999992, 348.890540000008, 
                                    388.983055000004, 432.878492999997, 458.900458999997, 503.358936999997, 
                                    550.483588000003, 610.447801999995, 655.951140000005, 703.708618000004, 
                                    758.174471999999, 789.146534, 901.765125999998, 950.725886, 1026.603449, 
                                    1077.17437199999, 1149.058987, 1237.27232, 1332.446102, 1489.511702, 
                                    1628.05721499999, 1705.372711, 1917.301093, 2061.31821300001, 
                                    2273.84210899999, 2427.374217, 2559.87082500001, 2853.32932199999, 
                                    3207.74597800001, 3423.54215199999, 3731.86295, 3954.567773, 
                                    4062.458184, 4281.808897, 4449.552, 4539.232433, 4405.575156, 
                                    4306.787193, 3965.031492, 3675.914554, 3266.643968, 2822.723136, 
                                    2302.719596, 1861.437023, 1474.691162, 3733.038507, 0, 0, 0, 
                                    0, 0, 0), 
                             px = c(0.99742019104, 0.999789935744351, 0.999854116362204, 
                                    0.999890030109484, 0.999859520366054, 0.999914084651963, 0.999930474421007, 
                                    0.999946556016646, 0.999910763726973, 0.999926358345821, 0.999951338436616, 
                                    0.99992676233662, 0.999920511751958, 0.999935674222339, 0.99990350113616, 
                                    0.999907686981066, 0.999873274131006, 0.999850887327229, 0.999796876178038, 
                                    0.99975729879787, 0.999746249323531, 0.999739901542935, 0.999732988047114, 
                                    0.99974122434283, 0.999705786527911, 0.999687079637053, 0.999731504755455, 
                                    0.999697961496275, 0.999696480942049, 0.999683174608181, 0.999655726241029, 
                                    0.999638442705668, 0.999606091488093, 0.999564493828614, 0.999555755950034, 
                                    0.999520745232787, 0.999526931187302, 0.99943112520689, 0.999399889102937, 
                                    0.999417591008109, 0.999286505615431, 0.999232143679539, 0.99921724960259, 
                                    0.999102716771179, 0.998984632387789, 0.998953360186892, 0.998787244705955, 
                                    0.998711841879745, 0.998534585410042, 0.998360851127784, 0.998187865520841, 
                                    0.997890091300901, 0.997762201446835, 0.997387770270733, 0.997073191516832, 
                                    0.996668163048204, 0.996375437348467, 0.995944222820784, 0.995468161792192, 
                                    0.99517386456552, 0.994680634466678, 0.994151523300543, 0.99347629460413, 
                                    0.99294398023755, 0.992376464626912, 0.991723318338184, 0.99131331201106, 
                                    0.989986657599463, 0.989336209400092, 0.988361015116145, 0.987643860848367, 
                                    0.986654380646557, 0.985435463826905, 0.98408330755863, 0.981919300507149, 
                                    0.979873642840306, 0.97848483181409, 0.975279249111375, 0.972748689315022, 
                                    0.969096903000758, 0.96595830085426, 0.962834997502366, 0.956975468767074, 
                                    0.949456721187304, 0.943184877303241, 0.934337543384664, 0.925529089521028, 
                                    0.917341699603603, 0.905028409331446, 0.890951296591969, 0.875137312888712, 
                                    0.861523311699355, 0.842869521190946, 0.828369956607765, 0.807917526544552, 
                                    0.788720624054306, 0.768526974677463, 0.754294970592157, 0.736682256324986, 
                                    0.716826476078745, 0, 0, 0, 0, 0, 0, 0), 
                             qx = c(0.00257980895999999, 
                                    0.000210064255648956, 0.000145883637795663, 0.000109969890515593, 
                                    0.000140479633946367, 0.0000859153480367025, 0.0000695255789927574, 
                                    0.0000534439833541622, 0.0000892362730269269, 0.0000736416541788909, 
                                    0.0000486615633842336, 0.0000732376633804099, 0.0000794882480422698, 
                                    0.0000643257776606898, 0.000096498863840444, 0.000092313018933976, 
                                    0.000126725868993871, 0.00014911267277129, 0.000203123821961859, 
                                    0.000242701202130102, 0.000253750676469378, 0.000260098457065316, 
                                    0.000267011952886476, 0.000258775657170474, 0.000294213472089355, 
                                    0.000312920362947389, 0.000268495244545308, 0.000302038503725455, 
                                    0.000303519057950785, 0.000316825391818765, 0.000344273758970615, 
                                    0.00036155729433196, 0.000393908511906682, 0.000435506171385547, 
                                    0.000444244049966458, 0.000479254767213, 0.000473068812697597, 
                                    0.000568874793109631, 0.000600110897062689, 0.000582408991891326, 
                                    0.00071349438456858, 0.000767856320461058, 0.000782750397409604, 
                                    0.000897283228821211, 0.00101536761221088, 0.00104663981310804, 
                                    0.00121275529404463, 0.0012881581202554, 0.00146541458995841, 
                                    0.00163914887221639, 0.00181213447915873, 0.00210990869909933, 
                                    0.00223779855316519, 0.00261222972926711, 0.00292680848316773, 
                                    0.00333183695179562, 0.00362456265153288, 0.00405577717921557, 
                                    0.00453183820780778, 0.00482613543448029, 0.00531936553332202, 
                                    0.00584847669945743, 0.00652370539586977, 0.00705601976244963, 
                                    0.00762353537308802, 0.00827668166181628, 0.00868668798893957, 
                                    0.0100133424005366, 0.0106637905999076, 0.0116389848838546, 0.0123561391516326, 
                                    0.0133456193534435, 0.0145645361730949, 0.0159166924413704, 0.0180806994928514, 
                                    0.0201263571596939, 0.0215151681859099, 0.0247207508886248, 0.0272513106849778, 
                                    0.0309030969992415, 0.0340416991457398, 0.0371650024976337, 0.0430245312329257, 
                                    0.0505432788126964, 0.0568151226967595, 0.0656624566153361, 0.0744709104789718, 
                                    0.0826583003963967, 0.0949715906685543, 0.109048703408031, 0.124862687111288, 
                                    0.138476688300645, 0.157130478809054, 0.171630043392235, 0.192082473455448, 
                                    0.211279375945694, 0.231473025322537, 0.245705029407843, 0.263317743675014, 
                                    0.283173523921255, 1, 1, 1, 1, 1, 1, 1), 
                             Lx = c(99871.009552, 
                                    99731.5429875, 99713.793035, 99701.0368415, 99688.5518865, 99677.2672015, 
                                    99669.520203, 99663.3920165, 99656.282065, 99648.166126, 99642.0724345, 
                                    99635.9993185, 99628.3908305, 99621.2268205, 99613.216098, 99603.8120085, 
                                    99592.9035335, 99579.1678235, 99561.6303155, 99539.4369825, 99514.728779, 
                                    99489.1610405, 99462.940199, 99436.7919535, 99409.298449, 99379.1212115, 
                                    99350.23058, 99321.889474, 99291.8169245, 99261.019461, 99228.208989, 
                                    99193.189961, 99155.7217195, 99114.60152, 99071.003568, 99025.257976, 
                                    98978.1058585, 98926.542178, 98868.7207615, 98810.2633845, 98746.240994, 
                                    98673.103045, 98596.601739, 98513.7811465, 98419.572524, 98318.102361, 
                                    98207.036917, 98084.2355155, 97949.200081, 97797.161566, 97628.4056465, 
                                    97436.9674175, 97225.1602925, 96989.408293, 96720.814225, 96418.17229, 
                                    96082.834171, 95713.8973735, 95302.9665995, 94857.0771235, 94375.9474255, 
                                    93849.026163, 93268.560468, 92635.360997, 91955.531118, 91224.589573, 
                                    90450.92907, 89605.47324, 88679.227734, 87690.5630665, 86638.674156, 
                                    85525.5574765, 84332.391823, 83047.532612, 81636.55371, 80077.7692515, 
                                    78411.0542885, 76599.7173865, 74610.4077335, 72442.8275725, 70092.2194095, 
                                    67598.5968885, 64891.996815, 61861.459165, 58545.8151, 54968.112549, 
                                    51124.8971875, 47116.384209, 42944.2506685, 38578.57022, 34084.1780035, 
                                    29611.774209, 25255.5930345, 21119.683692, 17299.210669, 13827.931408, 
                                    10783.247856, 8220.52649, 6138.4481805, 4470.384088, 1866.5192535, 
                                    0, 0, 0, 0, 0, 0), 
                             Tx = c(8372465.26535, 8272594.255798, 8172862.7128105, 
                                    8073148.9197755, 7973447.882934, 7873759.3310475, 7774082.063846, 
                                    7674412.543643, 7574749.1516265, 7475092.8695615, 7375444.7034355, 
                                    7275802.631001, 7176166.6316825, 7076538.240852, 6976917.0140315, 
                                    6877303.7979335, 6777699.985925, 6678107.0823915, 6578527.914568, 
                                    6478966.2842525, 6379426.84727, 6279912.118491, 6180422.9574505, 
                                    6080960.0172515, 5981523.225298, 5882113.926849, 5782734.8056375, 
                                    5683384.5750575, 5584062.6855835, 5484770.868659, 5385509.849198, 
                                    5286281.640209, 5187088.450248, 5087932.7285285, 4988818.1270085, 
                                    4889747.1234405, 4790721.8654645, 4691743.759606, 4592817.217428, 
                                    4493948.4966665, 4395138.233282, 4296391.992288, 4197718.889243, 
                                    4099122.287504, 4000608.5063575, 3902188.9338335, 3803870.8314725, 
                                    3705663.7945555, 3607579.55904, 3509630.358959, 3411833.197393, 
                                    3314204.7917465, 3216767.824329, 3119542.6640365, 3022553.2557435, 
                                    2925832.4415185, 2829414.2692285, 2733331.4350575, 2637617.537684, 
                                    2542314.5710845, 2447457.493961, 2353081.5465355, 2259232.5203725, 
                                    2165963.9599045, 2073328.5989075, 1981373.0677895, 1890148.4782165, 
                                    1799697.5491465, 1710092.0759065, 1621412.8481725, 1533722.285106, 
                                    1447083.61095, 1361558.0534735, 1277225.6616505, 1194178.1290385, 
                                    1112541.5753285, 1032463.806077, 954052.7517885, 877453.034402, 
                                    802842.6266685, 730399.799096, 660307.5796865, 592708.982798, 
                                    527816.985983, 465955.526818, 407409.711718, 352441.599169, 301316.7019815, 
                                    254200.3177725, 211256.067104, 172677.496884, 138593.3188805, 
                                    108981.5446715, 83725.951637, 62606.267945, 45307.057276, 31479.125868, 
                                    20695.878012, 12475.351522, 6336.9033415, 1866.5192535, 0, 0, 
                                    0, 0, 0, 0), 
                             ESPER = c(83.7246526535, 82.9399116852873, 81.9572330025609, 
                                       80.9691180138648, 79.977968167213, 78.9891347717685, 77.9958787725127, 
                                       77.00126709298, 76.0053558439442, 75.0120942618046, 74.0175818597982, 
                                       73.021159514362, 72.0264711836447, 71.0321571494952, 70.036694477221, 
                                       69.0434053368236, 68.0497333696581, 67.0582947532684, 66.0682209186112, 
                                       65.0815420920911, 64.0972199150188, 63.1133618486204, 62.1296517244004, 
                                       61.1461119731462, 60.1618097728354, 59.1793682469794, 58.1977359638214, 
                                       57.213231692078, 56.2303664470755, 55.2472868110517, 54.2646376388294, 
                                       53.2831537673462, 52.3022448041122, 51.322658190283, 50.3448014150822, 
                                       49.3669545129145, 48.3903854632186, 47.4130516336677, 46.4397544767843, 
                                       45.4673399784143, 44.49354462338, 43.524956182397, 42.5580185540903, 
                                       41.5909652738858, 40.6278686206363, 39.6686545715143, 38.7096929972649, 
                                       37.7560882708448, 36.8041419041578, 35.8574205987565, 34.9154718294648, 
                                       33.977950512359, 33.0487352807717, 32.1217361547405, 31.2045557377919, 
                                       30.2946858856786, 29.3942887816891, 28.4993989199312, 27.6134206899954, 
                                       26.7368537042729, 25.8640903750296, 24.9997327746601, 24.143861826336, 
                                       23.2991202756956, 22.4611344944567, 21.6298421287259, 20.8061866530807, 
                                       19.9841258631803, 19.1812004622625, 18.3825601294734, 17.59314598206, 
                                       16.806993603319, 16.027564183755, 15.2570584312586, 14.4957410291501, 
                                       13.7534534374886, 13.0256760239734, 12.3010937080661, 11.6002202382739, 
                                       10.911190125674, 10.2431879035382, 9.58655124648923, 8.93728808161327, 
                                       8.3166189803, 7.73272804949471, 7.16840968673561, 6.63704563618316, 
                                       6.13085115926411, 5.63822653183354, 5.17742015483161, 4.74991677179604, 
                                       4.35628564706906, 3.97612455136302, 3.6241550014187, 3.27144894801876, 
                                       2.93036121505148, 2.58139681013862, 2.20829376029664, 1.76475560211617, 
                                       1.21682647607875, 0.5, 0, 0, 0, 0, 0, 0), 
                             VAR = c(177.493971456874, 
                                     159.992508364695, 158.597908766107, 157.652824069484, 156.957948176113, 
                                     156.092412059532, 155.576469161554, 155.169702176614, 154.865197521052, 
                                     154.370208613829, 153.972673407646, 153.717145177379, 153.34318556806, 
                                     152.948665989068, 152.638473146803, 152.18653210509, 151.766820317148, 
                                     151.207694744975, 150.569515207335, 149.726533368374, 148.750197914213, 
                                     147.761173748562, 146.77945199548, 145.804010764623, 144.889558831661, 
                                     143.88439476811, 142.851368079721, 141.99549188033, 141.066407546459, 
                                     140.166048408382, 139.260338081149, 138.312528583539, 137.354595399541, 
                                     136.350944446594, 135.284593053106, 134.240122727728, 133.159060473242, 
                                     132.136196614313, 130.958125751811, 129.768880326716, 128.665608757264, 
                                     127.374762485323, 126.049235057843, 124.761414039407, 123.355929427052, 
                                     121.84324567598, 120.362063140818, 118.733611986147, 117.094479826258, 
                                     115.329614590603, 113.463466109905, 111.51576735944, 109.37734206818, 
                                     107.24180094273, 104.897571551398, 102.430692122719, 99.7963933931832, 
                                     97.1122061209103, 94.3031516098488, 91.3716749740192, 88.4615188621829, 
                                     85.4770864884083, 82.4295124393061, 79.2774165517566, 76.1225209086878, 
                                     72.975748949599, 69.8296438931944, 66.7988091652584, 63.5983179415514, 
                                     60.4843358733486, 57.3893856402341, 54.4094366371762, 51.5032730756889, 
                                     48.6520216814912, 45.8637469656544, 43.0395766654091, 40.2467391262582, 
                                     37.6115439294614, 34.9517370893421, 32.3893684211357, 29.8634761076295, 
                                     27.4613644702855, 25.2210062549832, 23.0217377940715, 20.8348702201982, 
                                     18.763985331436, 16.7555553681696, 14.84952360855, 13.0957013989722, 
                                     11.434939732776, 9.85956777600228, 8.35727843750646, 6.96629059011718, 
                                     5.63899694182123, 4.41790265667919, 3.26738989934882, 2.20351545327136, 
                                     1.24466990590529, 0.471295560614299, 0, 0, 0, 0, 0, 0, 0, 0), 
                             SD = c(13.3226863453612, 12.64881450432, 12.5935661655509, 
                                    12.5559875784219, 12.5282859233062, 12.4936948922059, 12.4730296705153, 
                                    12.4567131369641, 12.4444846225568, 12.4245808224595, 12.4085725773614, 
                                    12.3982718625371, 12.383181560813, 12.3672416483656, 12.354694376908, 
                                    12.3363905622791, 12.3193676914502, 12.2966538027617, 12.2706770476341, 
                                    12.2362793923796, 12.1963190313394, 12.1557053990528, 12.1152569925479, 
                                    12.0749331577704, 12.0370078853368, 11.9951821481839, 11.952044514631, 
                                    11.9161861298123, 11.8771380200139, 11.8391743127797, 11.8008617516328, 
                                    11.7606347015601, 11.7198376865698, 11.6769407143564, 11.6311905260427, 
                                    11.5862039826566, 11.5394566801579, 11.4950509617971, 11.4436937110275, 
                                    11.3916144741084, 11.343086385868, 11.2860428178048, 11.2271650499065, 
                                    11.1696649027358, 11.1065714523903, 11.0382628015454, 10.9709645492463, 
                                    10.8964953992624, 10.8210202765847, 10.7391626577961, 10.6519231179119, 
                                    10.560102620687, 10.4583623033523, 10.3557617268229, 10.2419515499439, 
                                    10.1208049147644, 9.98981448242074, 9.85455255812816, 9.71098098082005, 
                                    9.55885322483922, 9.40539838933912, 9.24538190062522, 9.07907002061919, 
                                    8.90378664118568, 8.72482211329766, 8.54258444205259, 8.35641333905847, 
                                    8.17305384573345, 7.97485535552536, 7.77716759966947, 7.57557823801154, 
                                    7.37627525497633, 7.17657808956949, 6.97510011981844, 6.77227782696888, 
                                    6.56045552270642, 6.34403177216651, 6.13282511812145, 5.91199941553973, 
                                    5.69116582267075, 5.46474849445329, 5.2403591928689, 5.0220519964436, 
                                    4.79809730977515, 4.56452300029239, 4.33174160487858, 4.09335502591329, 
                                    3.85350796139699, 3.61879833632273, 3.38155877263371, 3.13999486878598, 
                                    2.89089578461529, 2.63937314340303, 2.37465722617418, 2.10188074273475, 
                                    1.80759229345249, 1.48442428344169, 1.11564775171435, 0.686509694479473, 
                                    0, 0, 0, 0, 0, 0, 0, 0), 
                             VaR_10 = c(96.7774795182746, 95.7866189514946, 
                                        94.7873612217064, 93.7878765989255, 92.7882650435044, 91.7887612025085, 
                                        90.7890646036778, 89.789310104978, 88.7894988075444, 87.7898138703958, 
                                        86.7900738507639, 85.7902456301687, 84.7905041526892, 83.7907847186753, 
                                        82.7910117483446, 81.7913523069306, 80.7916780616206, 79.7921252112839, 
                                        78.7926512856555, 77.7933678062644, 76.7942237624399, 75.7951184705916, 
                                        74.796035327887, 73.7969763107153, 72.7978880243252, 71.7989243235508, 
                                        70.8000261892139, 69.8009713278164, 68.8020342576382, 67.803102075187, 
                                        66.8042163677508, 65.8054268141302, 64.8066975907622, 63.808081572652, 
                                        62.8096111035312, 61.8111706430212, 60.8128523418529, 59.8145115386903, 
                                        58.8165058124921, 57.8186083922401, 56.8206477261112, 55.8231446069105, 
                                        54.8258298106074, 53.8285649972438, 52.8316979449238, 51.8352400140954, 
                                        50.8388874678143, 49.8431093968615, 48.8475883850197, 47.8526771389314, 
                                        46.8583608559759, 45.8646340976106, 44.8719249371682, 43.8796413877199, 
                                        42.888628807023, 41.8986722352425, 40.9100720673372, 39.9224321367875, 
                                        38.9362125550665, 37.9515480475022, 36.9678054144804, 35.9856378023112, 
                                        35.0063003116511, 34.0328101742962, 33.0612961063714, 32.0918559982151, 
                                        31.1247811738777, 30.1590513705343, 29.1982122448138, 28.2394993336827, 
                                        27.2840815507612, 26.3308599068351, 25.3807599897196, 24.4344909052053, 
                                        23.4923549240947, 22.5570398168879, 21.6277413134065, 20.701800383124, 
                                        19.7850628479213, 18.8745795314368, 17.9733254713658, 17.0974051013597, 
                                        16.2349263171392, 15.3882126914159, 14.5605390144859, 13.744458325733, 
                                        12.9449412270554, 12.1986641992908, 11.4741427732921, 10.7644956964894, 
                                        10.0261607494316, 9.14775693507198, 8.2657727323304, 7.38114221445399, 
                                        6.48735680304087, 5.58582657631289, 4.6733328788028, 3.74894750561972, 
                                        2.81063236613434, 1.86049622420892, 0, 0, 0, 0, 0, 0, 0), 
                             VaR_5 = c(99.1408631680672, 98.1496101146363, 97.1503205085662, 
                                       96.1508137532664, 95.151185516361, 94.1516603681592, 93.1519507399747, 
                                       92.152185698391, 91.1523662972559, 90.1526678299507, 89.1529166456414, 
                                       88.1530810480981, 87.1533284685475, 86.1535969858209, 85.1538142658578, 
                                       84.1541401993904, 83.1544519647701, 82.1548799118998, 81.1553833943707, 
                                       80.1560691444966, 79.156888342225, 78.1577446277528, 77.1586221112445, 
                                       76.1595226842147, 75.160395244913, 74.1613870409837, 73.1624415877865, 
                                       72.1633461380641, 71.1643634210985, 70.1653853819597, 69.1664518219985, 
                                       68.1676102865937, 67.1688264906005, 66.1701510383433, 65.1716148845747, 
                                       64.1731074507179, 63.1747169301541, 62.1763048739286, 61.1782135050186, 
                                       60.1802257909307, 59.1821775470164, 58.1845672009934, 57.187137090471, 
                                       56.1897548164054, 55.1927532218098, 54.1961431792659, 53.1996339956027, 
                                       52.2036746168212, 51.2079612579247, 50.2128314788124, 49.2182711125517, 
                                       48.2242749541548, 47.2312526936403, 46.2386377665495, 45.2472392273346, 
                                       44.256851347462, 43.2677616216364, 42.2795908964361, 41.2927795241645, 
                                       40.3074564444633, 39.3230156500389, 38.3400822382836, 37.3587466068709, 
                                       36.3794440863747, 35.4016843749485, 34.42554390012, 33.4512501120896, 
                                       32.4780064443419, 31.5085811554826, 30.5408159009839, 29.5756233059326, 
                                       28.6121453384692, 27.6511046479371, 26.6930548661212, 25.7382319898585, 
                                       24.7887344862585, 23.8439344242846, 22.9017557754577, 21.9667626440959, 
                                       21.0144791101267, 20.0449347577812, 19.0774468014214, 18.1117334933508, 
                                       17.1499507434092, 16.1929150199896, 15.2387696521556, 14.2887539068452, 
                                       13.3417210509771, 12.3961332700901, 11.4534834539814, 10.5130803747158, 
                                       9.57387846753599, 8.6328863661652, 7.69057110722699, 6.74367840152044, 
                                       5.79291328815645, 4.8366664394014, 3.87447375280986, 2.90531618306717, 
                                       1.93024811210446, 0, 0, 0, 0, 0, 0, 0), 
                             VaR_1 = c(100.732121702435, 
                                       99.7328127772672, 98.7328689037522, 97.7329078738083, 96.7329372459002, 
                                       95.7329747627781, 94.7329977043443, 93.7330162678335, 92.7330305365077, 
                                       91.7330543598676, 90.7330740181861, 89.7330870072217, 88.7331065553056, 
                                       87.733127770198, 86.7331449369617, 85.7331706881721, 84.7331953199914, 
                                       83.7332291310463, 82.7332689099636, 81.733323089402, 80.7333878122088, 
                                       79.7334554652318, 78.7335247930541, 77.7335959451195, 76.7336648840038, 
                                       75.733743243383, 74.733826560544, 73.7338980268467, 72.7339783998885, 
                                       71.734059142514, 70.7341433993303, 69.7342349267816, 68.7343310160824, 
                                       67.7344356653565, 66.7345513202631, 65.7346692442597, 64.7347964052893, 
                                       63.7349218648389, 62.7350726611082, 61.7352316468912, 60.7353858503608, 
                                       59.7355746510707, 58.7357776917462, 57.735984511863, 56.7362214085326, 
                                       55.7364892407712, 54.736765041623, 53.7370842812123, 52.7374229582304, 
                                       51.7378077424584, 50.7382375146017, 49.7387118634268, 48.7392631575391, 
                                       47.739846634068, 46.7405262144246, 45.7412856445014, 44.742147638551, 
                                       43.7430822405899, 42.7441242417755, 41.745283829313, 40.7465131240501, 
                                       39.7478615134012, 38.7493361394651, 37.7509713966446, 36.7527285473913, 
                                       35.754613630057, 34.7566446149252, 33.7587585672258, 32.7611742002933, 
                                       31.7637209886113, 30.7664710364532, 29.7693565528227, 28.7724346324751, 
                                       27.7757490165022, 26.7793183504362, 25.7833084290255, 24.7876696409765, 
                                       23.7922379643618, 22.797373997889, 21.8028958220253, 20.8089869515562, 
                                       19.8154893602843, 18.8223466986702, 17.8299901486818, 16.8385830039979, 
                                       15.8477539304311, 14.857750781369, 13.8683442101954, 12.879226654018, 
                                       11.8906966907963, 10.9026160749432, 9.9147756935072, 8.92657727323304, 
                                       7.9381142214454, 6.94873568030409, 5.95858265763129, 4.96733328788028, 
                                       3.97489475056197, 2.98106323661343, 1.98604962242089, 0, 
                                       0, 0, 0, 0, 0, 0)), class = c("tbl_df", "tbl", "data.frame"
                                       ), row.names = c(NA, -107L))


VIVIENDA <- structure(list(ID = c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 
                                  13, 14, 15, 16, 17, 18), COMUNIDAD_AUTONOMA = c("Nacional", "Andalucía", 
                                                                                  "Aragón", "Asturias", "Baleares", "Canarias", "Cantabria", "Castilla y León", 
                                                                                  "Castilla - La Mancha", "Cataluña", "Valencia", "Extremadura", 
                                                                                  "Galicia", "Madrid", "Murcia", "Navarra", "País Vasco", "La Rioja"
                                  ), MEDIA_ANUAL = c(0.0375384208059093, 0.0364889225609997, 0.0254304692859493, 
                                                     0.0201505006249996, 0.0500180955709857, 0.0358770830585085, 0.035352864829814, 
                                                     0.0190279023325375, 0.00973748400421415, 0.0440279490966762, 
                                                     0.0321245809725834, 0.00819527901092365, 0.0217063984115415, 
                                                     0.0493120379133136, 0.0233506650650841, 0.016526983459821, 0.024996915551041, 
                                                     0.0237836964737541)), class = c("tbl_df", "tbl", "data.frame"
                                                     ), row.names = c(NA, -18L))


#######################################################################################
###------- CARGA LAS FUNCIONES DIRECTAMENTE DESDE EL TEXTO EN SCRIPT ---------------### 
#######################################################################################



P <- function(C0, g, t, r) {
  q <- (C0 * (1 + g)^t * r) / ((1 + r) * ((1 + r)^t - 1))
  return(q)
}

D <- function(t, r, P) {
  q <- P * ((1 + r) / r) * ((1 + r)^t - 1)
  return(q)
}
integrar_D <- function(lower, upper, r, P) {
  integral <- integrate(function(x) D(x, r, P), lower = lower, upper = upper)
  return(integral$value)
}


C <- function(t, g, C0) {
  q <- C0 * (1 + g)^t
  return(q)
}
integrar_C <- function(lower, upper, g, C0) {
  integral <- integrate(function(x) C(x, g, C0), lower = lower, upper = upper)
  return(integral$value)
}

calcular_pago_mensual <- function(P, r) {
  r_m <- (1 + r)^(1/12) - 1
  suma_factores <- sum((1 + r_m)^(12 - 1:12))
  m <- P*(1 + r) / suma_factores
  return(round(m, 2))
}
P <- function(C0, g, t, r) {
  q <- (C0 * (1 + g)^t * r) / ((1 + r) * ((1 + r)^t - 1))
  return(q)
}

G <- function(t, r_0, r_k, P_T) {
  q <- integrar_D(t, t+1, r_k, P_T) - integrar_D(t, t+1, r_0, P_T)
  return(q)
}

L <- function(t, g, C0, r_0, P_T) {
  q <- integrar_C(t, t+1, g, C0) - integrar_D(t, t+1, r_0, P_T)
  return(q)
}
vector_val_H <- function(t_contr, g, C0, r_0, r_k, P_T) {
  resultados <- c()
  if (t_contr >= 1) {
    for (t in 0:(floor(t_contr) - 1)) {
      G_t <- G(t, r_0, r_k, P_T)
      resultados <- c(resultados, G_t)
    }
  }
  if (length(resultados) >= (w - x + 1)) {
    return(resultados) 
    
  }
  G_contrib = integrar_D(floor(t_contr), t_contr, r_k, P_T) - integrar_D(floor(t_contr), t_contr, r_0, P_T)
  L_contrib = integrar_C(t_contr, floor(t_contr)+1, g, C0) - integrar_D(t_contr, floor(t_contr)+1, r_0, P_T)
  salto <- G_contrib + L_contrib
  resultados <- c(resultados, salto) 
  
  if (length(resultados) >= (w - x + 1)) {
    return(resultados) 
  }
  if (floor(t_contr) + 1 <= w - x) {
    for (t in (floor(t_contr) + 1):(w - x)) {
      L_t <- L(t, g, C0, r_0, P_T)
      resultados <- c(resultados, L_t)
    }
  }
  return(resultados)
}
vector_prob_H <- function(TABLA_VIDA, x, w) {
  # Inicializar el vector de resultados
  vector_probabilidades <- c()
  
  # Bucle para calcular probabilidades de muerte diferida
  for (t in 0:(w - x)) {
    if (t == 0) {
      # Probabilidad de morir en el primer año (qx de la edad actual)
      prob_muerte_t <- TABLA_VIDA$qx[TABLA_VIDA$age == x]
    } else {
      # Probabilidad de sobrevivir t años y morir en el año t+1
      px_t <- prod(TABLA_VIDA$px[TABLA_VIDA$age >= x & TABLA_VIDA$age < (x + t)])
      qx_t <- TABLA_VIDA$qx[TABLA_VIDA$age == (x + t)]
      prob_muerte_t <- px_t * qx_t
    }
    
    # Agregar la probabilidad calculada al vector
    vector_probabilidades <- c(vector_probabilidades, prob_muerte_t)
  }
  
  return(vector_probabilidades)
}

H <- function(TABLA_VIDA, x, w, t_contr, g, C0, r_0, r_k, P_T) {
  
  VAL_H <- vector_val_H(t_contr, g, C0, r_0, r_k, P_T)
  
  PROB_H <- vector_prob_H(TABLA_VIDA, x, w)
  
  resultado <- sum(VAL_H * PROB_H)
  
  return(resultado)
}


generar_plots <- function(tabla) {
  # Filtrar la tabla para incluir solo las filas con "Éxito"
  tabla_exito <- subset(tabla, Estimación == "Éxito")
  tabla_referencias <- subset(tabla_exito, !is.na(Referencias))
  tabla_sin_referencias <- subset(tabla_exito, is.na(Referencias))
  colores <- rainbow(length(unique(tabla_referencias$Referencias)))
  nombres_referencias <- unique(tabla_referencias$Referencias)
  colores_asignados <- setNames(colores, nombres_referencias)
  par(mfrow = c(1, 2)) 
  ### Plot 
  plot(
    tabla_exito$Mensualidad, tabla_exito$r_k,
    xlab = "Mensualidad",
    ylab = "r_k",
    main = "r_k vs Mensualidad",
    type = "n" 
  )
  # Graficar los puntos sin referencias 
  if (nrow(tabla_sin_referencias) > 0) {
    lines(
      tabla_sin_referencias$Mensualidad, tabla_sin_referencias$r_k,
      type = "b", col = "black", lty = 1, pch = 16
    )
  }
  # Graficar los puntos con referencias 
  if (nrow(tabla_referencias) > 0) {
    for (i in seq_along(tabla_referencias$Mensualidad)) {
      points(
        tabla_referencias$Mensualidad[i], tabla_referencias$r_k[i],
        col = colores_asignados[tabla_referencias$Referencias[i]],
        pch = 16
      )
    }
  }
  # Añadir la leyenda 
  if (nrow(tabla_referencias) > 0) {
    legend(
      "topleft", legend = nombres_referencias, 
      col = colores, pch = 16, cex = 0.8, title = "Referencias"
    )
  }
  grid()
  ### Plot 
  plot(
    tabla_exito$T_risk, tabla_exito$r_k,
    xlab = "T_risk",
    ylab = "r_k",
    main = "r_k vs T_risk",
    type = "n" 
  )
  # Graficar los puntos sin referencias 
  if (nrow(tabla_sin_referencias) > 0) {
    lines(
      tabla_sin_referencias$T_risk, tabla_sin_referencias$r_k,
      type = "b", col = "black", lty = 1, pch = 16
    )
  }
  # Graficar los puntos con referencias 
  if (nrow(tabla_referencias) > 0) {
    for (i in seq_along(tabla_referencias$T_risk)) {
      points(
        tabla_referencias$T_risk[i], tabla_referencias$r_k[i],
        col = colores_asignados[tabla_referencias$Referencias[i]],
        pch = 16
      )
    }
  }
  # Añadir la leyenda
  if (nrow(tabla_referencias) > 0) {
    legend(
      "topright", legend = nombres_referencias, 
      col = colores, pch = 16, cex = 0.8, title = "Referencias"
    )
  }
  grid()
  par(mfrow = c(1, 1))
}


generar_plots_rk_menor_0_1 <- function(tabla) {
  tabla_exito <- subset(tabla, Estimación == "Éxito" & r_k < 0.1)
  tabla_referencias <- subset(tabla_exito, !is.na(Referencias))
  tabla_sin_referencias <- subset(tabla_exito, is.na(Referencias))
  colores <- rainbow(length(unique(tabla_referencias$Referencias)))
  nombres_referencias <- unique(tabla_referencias$Referencias)
  colores_asignados <- setNames(colores, nombres_referencias)
  par(mfrow = c(1, 2)) 
  plot(
    tabla_exito$Mensualidad, tabla_exito$r_k,
    xlab = "Mensualidad",
    ylab = "r_k",
    main = "r_k vs Mensualidad (r_k < 0.1)",
    type = "n" 
  )
  
  # Graficar los puntos sin referencias 
  if (nrow(tabla_sin_referencias) > 0) {
    lines(
      tabla_sin_referencias$Mensualidad, tabla_sin_referencias$r_k,
      type = "b", col = "black", lty = 1, pch = 16
    )
  }
  
  # Graficar los puntos con referencias 
  if (nrow(tabla_referencias) > 0) {
    for (i in seq_along(tabla_referencias$Mensualidad)) {
      points(
        tabla_referencias$Mensualidad[i], tabla_referencias$r_k[i],
        col = colores_asignados[tabla_referencias$Referencias[i]],
        pch = 16
      )
    }
  }
  # Añadir la leyenda
  if (nrow(tabla_referencias) > 0) {
    legend(
      "topleft", legend = nombres_referencias, 
      col = colores, pch = 16, cex = 0.8, title = "Referencias"
    )
  }
  grid()
  ### Plot
  plot(
    tabla_exito$T_risk, tabla_exito$r_k,
    xlab = "T_risk",
    ylab = "r_k",
    main = "r_k vs T_risk (r_k < 0.1)",
    type = "n" 
  )
  # Graficar los puntos sin referencias 
  if (nrow(tabla_sin_referencias) > 0) {
    lines(
      tabla_sin_referencias$T_risk, tabla_sin_referencias$r_k,
      type = "b", col = "black", lty = 1, pch = 16
    )
  }
  
  # Graficar los puntos con referencias 
  if (nrow(tabla_referencias) > 0) {
    for (i in seq_along(tabla_referencias$T_risk)) {
      points(
        tabla_referencias$T_risk[i], tabla_referencias$r_k[i],
        col = colores_asignados[tabla_referencias$Referencias[i]],
        pch = 16
      )
    }
  }
  # Añadir la leyenda 
  if (nrow(tabla_referencias) > 0) {
    legend(
      "topright", legend = nombres_referencias, 
      col = colores, pch = 16, cex = 0.8, title = "Referencias"
    )
  }
  grid()
  par(mfrow = c(1, 1))
}


newtonraphson_rktcontr <- function(x, w, g, C0, r_0, P_T, t_risk, 
                                   t_contr_inicial, r_k_inicial, 
                                   error_tolerancia = 1e-6, max_iter = 100) {
  iter <- 1
  error <- Inf
  variables <- c(t_contr = t_contr_inicial, r_k = r_k_inicial)  # Valores iniciales
  
  # El sistema de ecuaciones
  f <- function(vars) {
    t_contr <- vars["t_contr"]
    r_k <- vars["r_k"]
    c(
      D(t_contr, r_k, P_T) - C(t_contr, g, C0), # Condición de máxima anualidad
      H(TABLA_VIDA, x, w, t_contr, g, C0, r_0, r_k, P_T) # Condición de riesgo
    )
  }
  # Aproximar la jacobiana numéricamente
  jacobiana <- function(vars) {
    t_contr <- vars["t_contr"]
    r_k <- vars["r_k"]
    h <- 1e-8  # Aproximar desde la definición
    J <- matrix(0, nrow = 2, ncol = 2)
    # Derivadas parciales respecto a t_contr
    vars_t_contr <- vars
    vars_t_contr["t_contr"] <- t_contr + h
    J[, 1] <- (f(vars_t_contr) - f(vars)) / h
    # Derivadas parciales respecto a r_k
    vars_r_k <- vars
    vars_r_k["r_k"] <- r_k + h
    J[, 2] <- (f(vars_r_k) - f(vars)) / h
    return(J)
  }
  # Manejo de errores durante la iteración
  tryCatch(
    {
      while (error > error_tolerancia && iter <= max_iter) {
        # Evaluar las funciones y la jacobiana
        F <- f(variables)
        J <- jacobiana(variables)
        
        # Actualización de Newton-Raphson: 
        delta <- solve(J, -F)  # Resolver sistema lineal
        variables <- variables + delta
        
        # Restringir t_contr y r_k a los límites
        variables["t_contr"] <- max(1e-4, min(variables["t_contr"], t_risk)) # 1e-4 es virtualmente 0 y evita que el método explore valores negativos de t_contr, que por teoría sabemos que es una zona de divergencia garantizada
        variables["r_k"] <- max(r_0, variables["r_k"]) # r_k >= r_0 por definición
        
        # Calcular el error como la norma de F
        error <- sqrt(sum(F^2))
        iter <- iter + 1
      }
    },
    error = function(e) {
      cat("Error en la iteración de Newton-Raphson:", conditionMessage(e), "\n")
      return(list(t_contr = NA, r_k = NA, error = Inf))
    }
  )
  
  if (iter > max_iter) {
    cat("No se alcanzó la convergencia después de", max_iter, "iteraciones.\n")
  }
  
  return(list(t_contr = variables["t_contr"], r_k = variables["r_k"], error = error))
}



#######################################################################################
#Esto guarda el entorno. El programa lo elimina cada vez que reinicias para no acumular 
#problemas, lo puedes eliminar cuando acabes la sesión, debería estar en tu directorio
#usa getwd(), para encontrar la ubicación
save.image(file = "HIPOTECAINVERSAENTORNO.RData")
#######################################################################################
#######################################################################################
###-------------------------------INICIO DEL PROGRAMA-------------------------------###
#######################################################################################


cat("\n\n\n\n\n\n\n\n\n\n\n\n\n")
cat("╔════════════════════════════════════════════╗\n")
cat("║         Bienvenido a la calculadora        ║\n")
cat("╚════════════════════════════════════════════╝\n")
cat("Por favor, introduzca los datos para que el sistema calcule los contratos óptimos acorde a su nivel de riesgo de longevidad.\n\n")
#######################################################################################
###------------------------------TOMA DE DATOS MANUAL-------------------------------###
#######################################################################################
repetir <- 1
while(repetir == 1){
  rm(list = ls())
  repetir <- 1
  options(scipen = 999)
  load("HIPOTECAINVERSAENTORNO.RData")
  w <- 101
  confirmacion <- 1 
  while (confirmacion == 1) {
    #Pido los datos
    
    
    cat("Edad del prestatario (entre 65 y 95 años): ")
    x <- as.numeric(readline())
    while (x < 65 || x > 95) {
      cat("Por favor, ingrese una edad válida entre 60 y 95 años: ")
      x <- as.numeric(readline())
    }
    
    
    
    cat("Valor actual de la vivienda: ")
    C0 <- as.numeric(readline())
    
    cat("Lea la tabla y seleccione la comunidad autónoma del inmueble:\n")
    print(VIVIENDA[, c("ID", "COMUNIDAD_AUTONOMA")], row.names = FALSE)
    
    cat("Introduce el ID de la comunidad autónoma del inmueble: ")
    comunidad_id <- as.numeric(readline())
    g <- VIVIENDA$MEDIA_ANUAL[VIVIENDA$ID == comunidad_id]
    comunidad_nombre <- VIVIENDA$COMUNIDAD_AUTONOMA[VIVIENDA$ID == comunidad_id]
    cat("Comunidad autónoma seleccionada:", comunidad_nombre, "\nLa tasa de crecimiento media anual del mercado inmobiliario para esta comunidad autonoma es:", g, "\nSi considera que la tendencia seguirá siendo la misma introduzca el valor 0 y el programa tomará", g,
        "\nSi por contra considera que el mercado futuro tendrá otra tendencia de revalorización introdzca el valor (en formato decimal, por ejemplo, 0.1234):\n")
    g <- as.numeric(readline())
    if (g == 0) {
      g <- VIVIENDA$MEDIA_ANUAL[VIVIENDA$ID == comunidad_id]
    }
    cat("Introduzca la tasa de interés libre de riesgo (en formato decimal, por ejemplo, 0.1234):\n")
    cat("En caso de no saberla, introduzca el valor 0 y el programa tomará un valor por defecto de 0.0414.\n")
    r_0 <- as.numeric(readline())
    if (r_0 == 0) {
      r_0 <- 0.0414
    }
    
    # Mostrar Datos
    cat("\n--- Confirmación de datos ---\n")
    cat("Edad:", x, "\n")
    cat("Valor actual de la vivienda:", C0, "\n")
    cat("Comunidad autónoma:", comunidad_nombre, "\n")
    cat("Tasa de revalorización inmobiliaria:", g, "\n")
    cat("Tasa de interés libre de riesgo:", r_0, "\n")
    
    # Confirmar Datos
    cat("\nSi los datos son correctos, introduce 0 para continuar. Si no son correctos, pulsa 1 para volver a empezar.\n")
    confirmacion <- as.numeric(readline())
    
    if (confirmacion == 1) {
      cat("Reiniciando la toma de datos.\n\n\n")
    }
  }
  #######################################################################################
  ###------------------------ BUCLE ITERATIVO PARA EL PROGRAMA -----------------------###
  #######################################################################################
  
  rep2 <- 1
  while (rep2 == 1) {
    cat("\nEsta calculadora ofrece dos niveles de analisis:\n")
    cat("El análisis avanzado ofrece una amplia gama de resultados y contratos óptimos, sin embargo, es algo lento y requiere algo de CPU, si lo ejecutas ruego que esperes entre 10 y 15 segundos, si no ofrece resultados verifica que R no esté consuiendo CPU en el administrador de tareas. Si está consumiendo CPU siginifica que sigue ejecutandose, sino es que el programa ha fallado.\n")
    cat("\nPor otro lado el análisis simple es mucho más veloz que el avanzado y las conclusiones son aproximadamente iguales, sin embargo no es tán preciso, ni modeliza tablas de contratos óptimos extensas \n")
    cat("\n\n\nSeleccione el nivel del análisis que desea ejecutar:\n")
    cat("Para el Análisis avanzado, introduce 1\n")
    cat("Para el Análisis simple, introduce 2\n")
    opcion <- as.numeric(readline(prompt = "Ingrese 1 o 2: "))
    
    #######################################################################################  
    if (opcion == 1) {
      cat("\nRealizando Analisis avanzado, este proceso podría demorarse unos segundos...\n")
      #######################################################################################
      ###------------------------- ANALISIS ESTADISTICO EXTENSO --------------------------###
      #######################################################################################
      
      # Calcular los valores necesarios a partir de TABLA_VIDA
      fila_edad <- TABLA_VIDA[TABLA_VIDA$age == x, ]
      esperanza_vida <- fila_edad$ESPER
      sd_vida <- fila_edad$SD
      var_10 <- fila_edad$VaR_10
      var_5 <- fila_edad$VaR_5
      var_1 <- fila_edad$VaR_1
      no_risk <- w - x 
      
      t_refer <- c(no_risk, var_1, var_5, var_10, esperanza_vida + sd_vida, esperanza_vida + (sd_vida)/2, esperanza_vida)
      Refer <- c("No_risk", "VaR_1", "VaR_5", "VaR_10", "E[]+sd()", "E[]+sd()/2", "E[]")
      
      t_risk <- seq(w - x, 0, by = -0.25)
      # Inicializar la tabla de resultados
      resultados <- data.frame(
        Referencias = character(),
        T_risk = numeric(),
        T_contr = numeric(),
        r_k = numeric(),
        r_0 = numeric(),
        Prima_riesgo = numeric(),
        Anualidad = numeric(),       
        Mensualidad = numeric(),     
        Total_error = numeric(),
        Estimación = character()
      )
      
      
      # Inicializar contador de errores consecutivos
      errores_consecutivos <- 0
      
      # Bucle principal para calcular los resultados
      for (t_risk_actual in t_risk) {
        # Calcular P_T
        P_T <- P(C0, g, t_risk_actual, r_0)
        
        # Condiciones iniciales para Newton-Raphson
        t_contr_inicial <- t_risk_actual*0.7
        r_k_inicial <- r_0 + 0.03
        
        # Ejecutar Newton-Raphson
        result <- newtonraphson_rktcontr(
          x = x,
          w = w,
          g = g,
          C0 = C0,
          r_0 = r_0,
          P_T = P_T,
          t_risk = t_risk_actual,
          t_contr_inicial = t_contr_inicial,
          r_k_inicial = r_k_inicial
        )
        
        # Extraer los resultados
        t_contr <- result$t_contr
        r_k <- result$r_k
        total_error <- result$error
        
        # Verificar si el error es mayor que 10
        if (total_error > 10) {
          errores_consecutivos <- errores_consecutivos + 1
        } else {
          errores_consecutivos <- 0
        }
        
        # Detener el bucle si hay más de 3 errores consecutivos, esto sirve para ahorrar CPU cuando hemos entrado en la zona de divergencia
        if (errores_consecutivos > 3) {
          cat("El programa ha detectado más de 3 errores consecutivos con Total_Error > 10. Deteniendo el bucle.\n")
          break
        }
        
        # Calcular para agregar a la tabla
        prima_riesgo <- r_k - r_0 
        anualidad <- P_T
        mensualidad <- calcular_pago_mensual(P_T, r_0)
        # Agregar los resultados a la tabla
        resultados <- rbind(resultados, data.frame(
          Referencias = NA,
          T_risk = round(t_risk_actual, 8),
          T_contr = round(t_contr, 8),
          r_k = r_k,
          r_0 = round(r_0, 8),
          Prima_riesgo = round(prima_riesgo, 8),
          Anualidad = anualidad,         
          Mensualidad = mensualidad,    
          Total_error = formatC(total_error, format = "e"),
          Estimación = ifelse(total_error < 10, "Éxito", "Fracaso")
        ))
      }
      #Esto aproxima el valor de los estadísticos de la tabla y los selecciona
      rownames(resultados) <- NULL
      for (i in 1:length(t_refer)) {
        # Encontrar el índice del t_risk más cercano al t_refer actual
        idx <- which.min(abs(resultados$T_risk - t_refer[i]))
        # Asignar la referencia 
        resultados$Referencias[idx] <- Refer[i]
      }
      
      # Mostrar la tabla de resultados
      print(subset(resultados, select = -Referencias))
      generar_plots(resultados)
      generar_plots_rk_menor_0_1(resultados)
      
      
    } else if (opcion == 2) {
      cat("\n\nRealizando Análisis simple, este proceso podría demorarse unos segundos...\n\n")
      #######################################################################################
      ###------------------------- ANALISIS ESTADISTICO RESUMIDO -------------------------###
      #######################################################################################
      
      # Calcular los valores necesarios a partir de TABLA_VIDA
      fila_edad <- TABLA_VIDA[TABLA_VIDA$age == x, ]
      esperanza_vida <- fila_edad$ESPER
      sd_vida <- fila_edad$SD
      var_10 <- fila_edad$VaR_10
      var_5 <- fila_edad$VaR_5
      var_1 <- fila_edad$VaR_1
      no_risk <- w - x
      
      # Definir t_risk 
      t_risk <- c(no_risk, var_1, var_5, var_10, esperanza_vida + sd_vida, esperanza_vida + (sd_vida)/2, esperanza_vida)
      Refer <- c("No_risk", "VaR_1", "VaR_5", "VaR_10", "E[]+sd()", "E[]+sd()/2", "E[]")
      # Inicializar la tabla de resultados
      resultados <- data.frame(
        Referencias = character(),
        T_risk = numeric(),
        T_contr = numeric(),
        r_k = numeric(),
        r_0 = numeric(),
        Prima_riesgo = numeric(),
        Anualidad = numeric(),       
        Mensualidad = numeric(),     
        Total_error = numeric(),
        Estimación = character()
      )
      
      # Inicializar contador de errores 
      errores_consecutivos <- 0
      
      # Bucle principal para calcular los resultados
      for (t_risk_actual in t_risk) {
        # Calcular P_T
        P_T <- P(C0, g, t_risk_actual, r_0)
        
        # Condiciones iniciales para Newton-Raphson
        t_contr_inicial <- t_risk_actual * 0.7
        r_k_inicial <- r_0 + 0.03
        
        # Ejecutar Newton-Raphson
        result <- newtonraphson_rktcontr(
          x = x,
          w = w,
          g = g,
          C0 = C0,
          r_0 = r_0,
          P_T = P_T,
          t_risk = t_risk_actual,
          t_contr_inicial = t_contr_inicial,
          r_k_inicial = r_k_inicial
        )
        
        # Extraer los resultados, redondeo por presentación
        t_contr <- round(result$t_contr, 8) 
        r_k <- round(result$r_k, 8)         
        total_error <- round(result$error, 8) 
        
        # Verificar si el error es mayor que 10
        if (total_error > 10) {
          errores_consecutivos <- errores_consecutivos + 1
        } else {
          errores_consecutivos <- 0
        }
        
        # Detener el bucle si hay más de 3 errores consecutivos, esto sirve para ahorrar CPU cuando hemos entrado en la zona de divergencia
        if (errores_consecutivos > 3) {
          cat("El programa ha detectado más de 3 errores consecutivos con Total_Error > 10. Deteniendo el bucle.\n")
          break
        }
        
        # Calcular prima de riesgo
        prima_riesgo <- round(r_k - r_0, 8)
        
        # Calcular anualidad y mensualidad
        anualidad <- P_T
        mensualidad <- calcular_pago_mensual(P_T, r_0)
        
        # Agregar los resultados a la tabla
        resultados <- rbind(resultados, data.frame(
          Referencias = NA,
          T_risk = round(t_risk_actual, 8),
          T_contr = round(t_contr, 8),
          r_k = r_k,
          r_0 = round(r_0, 8),
          Prima_riesgo = round(prima_riesgo, 8),
          Anualidad = round(anualidad, 8),
          Mensualidad = round(mensualidad, 8),
          Total_error = formatC(total_error, format = "e"),
          Estimación = ifelse(total_error < 10, "Éxito", "Fracaso")
        ))
      }
      
      resultados$Referencias <- Refer[1:nrow(resultados)]
      rownames(resultados) <- NULL
      # Mostrar la tabla de resultados
      print(resultados)
      # Graficar los resultados
      generar_plots(resultados)
      
      
    } else {
      cat("\nOpción no válida.\n")
    }
    
    cat("\nPara cambiar de método pulse 1, para volver a la toma de datos o cerrar el programa, pulse 0\n")
    rep2 <- as.numeric(readline())
    if (rep2 == 1) {
      cat("\nReiniciando el programa...\n")
    }
    
    #######################################################################################
    ### CALCULO DEL CONTRATO A PARTIR DE LA ANUALIDAD ### PROYECTO FUTURO....
    #######################################################################################
    
    
  }
  
  
  
  #######################################################################################
  ###--------------------------------- FIN/REINICIO ----------------------------------###
  #######################################################################################
  
  #Reintroducir datos o cerrar el programa
  cat("Para volver a calcular su hipoteca inversa pulse 1, para cerrar el programa pulse 0")
  repetir <- as.numeric(readline())
  if(repetir == 1){
    cat("\n\n\nReiniciando el programa:\n\n\n")
  }
}
cat("\n\n\nFin del programa. ¡Espero que le haya sido útil!")